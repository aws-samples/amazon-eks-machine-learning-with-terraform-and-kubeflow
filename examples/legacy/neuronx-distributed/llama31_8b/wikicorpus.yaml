image: 'public.ecr.aws/neuron/pytorch-training-neuronx:2.9.0-neuronx-py312-sdk2.27.0-ubuntu24.04'
backoff_limit: 2000
ebs:
  storage: 200Gi
  mount_path: /tmp
resources:
  requests:
    "aws.amazon.com/neuron": 1 
  limits:
    "aws.amazon.com/neuron": 1 
tolerations:
  - key: "aws.amazon.com/neuron"
    operator: "Exists"
    effect: "NoSchedule"
git:
  repo_url: "https://github.com/aws-neuron/neuronx-distributed.git"
  commit: 47f695c2e23ce0fd6afc35529549ed41ba3cc16d
  branch: main
pre_script: 
  - pip3 install --upgrade pip
  - DATA_PATH="$DATA_ROOT/examples_datasets/wikicorpus_llama3_tokenized_8k"
  - 'if [ -d $DATA_PATH ] && [ ! -z "$(ls -A $DATA_PATH)" ]; then echo "$DATA_PATH exists and is not empty" && exit 0; fi'
  - mkdir -p $DATA_ROOT
  - SCRIPT_DIR=$GIT_CLONE_DIR/examples/training/llama/tp_zero1_llama_hf_pretrain
  - cp $GIT_CLONE_DIR/examples/training/llama/requirements.txt $SCRIPT_DIR
  - cp $GIT_CLONE_DIR/examples/training/llama/get_dataset.py $SCRIPT_DIR
  - cp $GIT_CLONE_DIR/examples/training/llama/modeling_llama_nxd.py $SCRIPT_DIR
  - cp $SCRIPT_DIR/8B_config_llama3.1/config.json $SCRIPT_DIR
  - cp $MODEL_PATH/tokenizer_config.json $SCRIPT_DIR
  - cp $MODEL_PATH/special_tokens_map.json $SCRIPT_DIR
  - cp $MODEL_PATH/tokenizer.json $SCRIPT_DIR
  - cd $SCRIPT_DIR
  - pip3 install huggingface-hub==0.27.1 
  - mkdir -p $LOG_ROOT 
process:
  env:
    - name: HOME
      value: /tmp
    - name: XDG_CACHE_HOME
      value: /tmp
    - name: DATA_ROOT
      value: /fsx/home/{{ .Release.Name }}
    - name: MODEL_PATH
      value: /fsx/pretrained-models/meta-llama/Llama-3.1-8B
    - name: LOG_ROOT
      value: /efs/home/{{ .Release.Name }}/logs
  command:
    -  HOME=$DATA_ROOT python3 
  args:
    - get_dataset.py 
    - '--llama-version 3'
    - '2>&1 | tee $LOG_ROOT/dataset.log'
